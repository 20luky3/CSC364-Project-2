--- /Users/anubhajoshi/CSC364-Project-2-Source-Code/p2/archive.php	2025-11-18 13:10:13
+++ /Users/anubhajoshi/CSC364-Project-2-Source-Code/p2/artifacts/exploits/vul4/fixed_archive.php	2025-11-16 12:15:22
@@ -15,12 +15,21 @@
         $status = 'Could not interpret that reference token.';
     } else {
         $path = trim($decoded);
-        $transcript = @file_get_contents($path);
-        if ($transcript === false) {
-            $transcript = @file_get_contents(__DIR__ . '/logs/' . $path);
+
+        $full_target_path = realpath($path);
+        if($full_target_path === false){
+          $full_target_path = realpath(realpath(__DIR__ . '/logs') . '/' . $path);
         }
-        if ($transcript === false) {
-            $status = 'No archive entry matched that reference.';
+
+        if($full_target_path === false || strpos($full_target_path, realpath(__DIR__ . '/logs')) !== 0){
+          $status = 'Unauthorized';
+          $transcript = null;
+        } 
+        else {
+          $transcript = @file_get_contents($full_target_path);
+          if ($transcript === false) {
+              $status = 'No archive entry matched that reference.';
+          }
         }
     }
 }
